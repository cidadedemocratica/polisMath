
The following was computed on the a 5000x10 conversation; it seems that reflection is one of our problems here

    2014-May-09 11:27:06 -0700 fullerine INFO [polismath.simulation] - Profiling: :user/clusters
                              Id  Calls       Min        Max       MAD      Mean   Time% Time
      :user/clean-start-clusters      2     9.0ms       4.4s      2.2s      2.2s      30 4.4s
    :user/safe-recenter-clusters      2     5.0ms       2.2s      1.1s      1.1s      15 2.2s
                :user/row-subset    106   260.0μs     68.0ms     8.0ms    20.0ms      15 2.2s
         :user/recenter-clusters      2     3.0ms       2.1s      1.1s      1.1s      14 2.1s
            :user/rowname-subset     53   462.0μs     47.0ms     8.0ms    20.0ms       7 1.0s
          :user/posible-clusters      2   306.0μs     23.0ms    12.0ms    12.0ms       0 24.0ms
          :user/uniqify-clusters      2    20.0μs      1.0ms   737.0μs   757.0μs       0 2.0ms
                      Clock Time                                                     100 14.8s
                  Accounted Time                                                      81 12.0s

Here are the reflection warnings that matter to our lib

    Auto-boxing loop arg: current-indent
    exception.clj:44 recur arg for primitive local: i is not matching primitive, had: Object, needed: long
    Auto-boxing loop arg: i

    # The main culprit?
    Reflection warning, polismath/named_matrix.clj:21:41 - call to indexOf can't be resolved.
    Reflection warning, polismath/named_matrix.clj:46:11 - call to indexOf can't be resolved.
    Reflection warning, polismath/named_matrix.clj:55:11 - call to indexOf can't be resolved.
    Reflection warning, polismath/named_matrix.clj:61:34 - call to indexOf can't be resolved.
    Reflection warning, polismath/named_matrix.clj:67:24 - call to indexOf can't be resolved.

    pca.clj:51 recur arg for primitive local: last_eigval is not matching primitive, had: Object, needed: long
    Auto-boxing loop arg: last-eigval

    Reflection warning, polismath/clusters.clj:136:27 - call to indexOf can't be resolved.
    Reflection warning, polismath/clusters.clj:136:27 - call to indexOf can't be resolved.
    Performance warning, polismath/clusters.clj:201:25 - case has int tests, but tested expression is not primitive.
    Reflection warning, polismath/conversation.clj:22:13 - call to indexOf can't be resolved.
    Reflection warning, polismath/simulation.clj:78:3 - reference to field nextElement can't be resolved.


Fuck... this doesn't seem to be working. I took away all of the reflection warnings with a type-indexof
function, but still no dice. What's left of the reflections:

    (defn typed-indexof [^java.util.List coll item]
      (.indexOf coll item))

    # Other libraries...
    Reflection warning, /tmp/form-init1039726133741870246.clj:1:911 - call to invokeStaticMethod can't be resolved.
    Reflection warning, alex_and_georges/debug_repl.clj:101:8 - reference to field getCause can't be resolved.
    Reflection warning, alex_and_georges/debug_repl.clj:102:8 - reference to field getCause can't be resolved.
    Reflection warning, plumbing/fnk/schema.clj:93:37 - call to java.lang.IllegalArgumentException ctor can't be resolved.
    Reflection warning, clojure/tools/trace.clj:231:9 - call to setStackTrace can't be resolved.
    Reflection warning, clojure/tools/trace.clj:242:11 - call to setStackTrace can't be resolved.
    Reflection warning, clojure/tools/trace.clj:244:49 - call to java.lang.Exception ctor can't be resolved.
    Reflection warning, clojure/tools/trace.clj:244:11 - call to setStackTrace can't be resolved.
    Reflection warning, clojure/tools/trace.clj:276:9 - call to setStackTrace can't be resolved.
    Reflection warning, clojure/tools/trace.clj:277:15 - call to setStackTrace can't be resolved.
    Reflection warning, bigml/sampling/random.clj:11:11 - call to cern.jet.random.tdouble.engine.MersenneTwister64 vector can't be resolved.
    Reflection warning, clj_time/core.clj:577:10 - reference to field getDayOfMonth can't be resolved.

    # Us????
    columns.clj:125 recur arg for primitive local: current_indent is not matching primitive, had: Object, needed: long
    Auto-boxing loop arg: current-indent
    exception.clj:44 recur arg for primitive local: i is not matching primitive, had: Object, needed: long
    Auto-boxing loop arg: i
    pca.clj:51 recur arg for primitive local: last_eigval is not matching primitive, had: Object, needed: long
    Auto-boxing loop arg: last-eigval

    Performance warning, polismath/clusters.clj:201:25 - case has int tests, but tested expression is not primitive.
    Reflection warning, polismath/conversation.clj:22:13 - call to indexOf can't be resolved.
    Reflection warning, polismath/simulation.clj:78:3 - reference to field nextElement can't be resolved.


May 12, 2014

WOOT! It seems I've sorted out the biggest culrpit here.
It turned out to be the filter-by-index function.
It was creating a new set each time, which was absolutely killing performance.
I was able to cut down an order of magnitude by doing this alone.

So now on to other things...

For starters, I tried running on 100,000 ptpts 10 cmts.
There are the big and big-part update times

    N-ptpts: 99998
    Starting new conv update!
    1399963793428 rating-mat 1292120.671242 msecs #=> 1,292.120s #=> 20 minutes
    1399963793436 mat 7.876006 msecs
    1399963800685 pca 7249.400704 msecs # 7 sec
    1399963802045 proj 1359.328171 msecs # 1.3 sec
    1399963848873 base-clusters 46828.255953 msecs # 46 sec
    1399963848873 bid-to-pid 0.054336 msecs 
    1399963849626 votes-base 752.377173 msecs
    1399963849626 counting-ptpts 0.003771 msecs
    1399963849628 group-clusters 2.392552 msecs
    1399963849628 CONVUP big 1353257.322353 msecs

    N-ptpts: 99998
    1399963849843 rating-mat 140.33363 msecs
    1399963849849 mat 5.574799 msecs
    1399963855133 pca 5283.952589 msecs
    1399963856372 proj 1238.580412 msecs
    1399964442254 base-clusters 585882.249774 msecs # 585.882 # 10 min
    1399964442254 bid-to-pid 0.056502 msecs
    1399964442916 votes-base 661.268519 msecs
    1399964442916 counting-ptpts 0.003702 msecs
    1399964442917 group-clusters 1.644483 msecs
    1399964442918 CONVUP big-part 593284.9938 msecs

    2014-May-13 00:00:42 -0700 noether INFO [polismath.simulation] - Profiling: :user/clusters
                              Id  Calls       Min        Max       MAD      Mean   Time% Time
                    :user/kmeans      2     2.0ms     585.9s    292.9s    292.9s      99 585.9s
      :user/clean-start-clusters      2     1.0ms     546.2s    273.1s    273.1s      92 546.2s
    :user/safe-recenter-clusters      2   604.0μs     276.2s    138.1s    138.1s      47 276.2s
         :user/safe-recenter-map      2   552.0μs     276.2s    138.1s    138.1s      47 276.2s
       :user/safe-rowname-subset     53    90.0μs       9.6s      1.7s      5.2s      46 274.5s
         :user/recenter-clusters      2   485.0μs     269.9s    135.0s    135.0s      45 269.9s
            :user/rowname-subset     53    82.0μs       8.7s      1.6s      5.1s      45 268.4s
                :user/row-subset    106    46.0μs     47.0ms     3.0ms    28.0ms       1 3.0s
           :user/filter-by-index    212     5.0μs    862.0μs   129.0μs   439.0μs       0 93.0ms
          :user/uniqify-clusters      2    12.0μs      1.0ms   510.0μs   522.0μs       0 1.0ms
       :user/safe-recenter-empty      2     3.0μs    301.0μs   149.0μs   152.0μs       0 303.0μs
         :user/safe-recenter-nil      2    21.0μs    155.0μs    67.0μs    88.0μs       0 175.0μs
                      Clock Time                                                     100 593.3s
                  Accounted Time                                                     421 2500.3s


Hmm.... This is suggesting that performance on the rating-mat update may actually become a problem if we can't
keep everything else moving quickly enough.
Of course, this corresponds to 1,000,000 votes.
If we ever get 1,000,000 votes at once then (for a specific conv), God help us for now... XXX

On the other hand, note that the base clustering takes QUITE a long time in this second one here (10 minutes).
Again, this seems to be due largely due to the clean-start-clusters.
We really have to figure out how to speed that up. XXX

Another thought: initially I was concerned that something might not be quite right given that the second
(partial) updata would always take so much longer than the full matrix population.
But this actually makes sense: most of the time is in the clean-start-clusters, but the clean-start-clusters
is going to be a lot simpler if the last round didn't have that many members.

Also, note that there are still some strange "unable to slice nil" errors cropping up every now and again.
A few of those leading to a backlog, and it might put us on ice while the conversation catches up. XXX

One last thing:
Note that the PCA grows as a function of the number of comments, but that downstream analyses don't, because
they're just on projections.

    # 10 cmts
    big
    1399967451528 pca 942.879957 msecs # 1 sec
    1399967451706 proj 177.306975 msecs # 0.2 sec
    big-part
    1399967458208 pca 751.15802 msecs # < 1sec
    1399967458369 proj 161.097721 msecs 

    # 100 cmts
    big
    1399967669033 pca 6840.381594 msecs # 7 sec
    1399967669866 proj 833.318748 msecs # 0.8 sec
    big-part
    1399967679124 pca 3850.089523 msecs # 4 sec
    1399967679911 proj 786.742437 msecs # 0.8 sec

Something interesting here: Note the second times are a lot shorter in each case (1/2-ish).
This is likely because the power-iteration is working exactly as planned.
Which is good.
Still, if it's another 7x to increase both the cmts and ptpts 10x, then we could easily expect to see minute long
compute times for our PCA step.
So we'll either want to fix our Batch PCA or try to speed this bit up XXX

Also note here that the time for update is much lower than it was when there were 10x more people (80sec).
Could this let us use a tranpose for this messy operation? XXX
In general this may also point to where some of the possible optimizations are with respect to this update
implementation.


